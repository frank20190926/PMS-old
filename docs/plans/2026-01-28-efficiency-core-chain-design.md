# 人效中心核心链路设计方案（任务+日报+进度+周报+回写）

**日期**: 2026-01-28
**范围**: 人效中心模块（不改动老 PMS 功能）

---

## 1. 目标与范围

### 目标
- 老系统录入项目，人效中心完成任务拆分/下发、进度管理与日报闭环。
- 日报回写到老系统 `pms_report`，两块功能并行且保持连接。
- 任务、日报、进度、周报形成完整项目管理闭环。

### 范围
- 任务管理：阶段→里程碑→周/日任务。
- 日报管理：每日一份、多条任务明细、工作日必报。
- 进度管理：PM 审核后更新任务进度，可回退。
- 周报管理：日报汇总生成、PM 审核。
- 老系统回写：日报按项目拆分回写，准实时异步。

### 约束
- 仅在人效中心目录开发；老 PMS 功能不修改。
- 同一部署内调用 Service，避免 HTTP 网络开销。

---

## 2. 核心业务设计

### 2.1 任务结构
- **层级**: 阶段 → 里程碑 → 周/日任务。
- **阶段模板**: 可配置，默认 5 阶段。
- **里程碑**: 支持自动生成 + 手动创建。
- **任务拆分**: PM 自主选择拆到周或日。
- **任务模板**: 系统内置 + 历史项目复制；应用时支持按角色映射负责人。
- **状态流转**: PENDING → IN_PROGRESS → DELAYED → COMPLETED。
- **延期**: 到期未完成自动标记 + PM 手动标记；允许调整计划时间并记录原因。
- **归档**: 任务不可删除，仅归档；有工时的归档任务参与统计。

### 2.2 日报与审批
- **日报结构**: 每日一份，包含多条任务明细。
- **约束**: 员工仅对已下发任务填报进度/成果。
- **频率**: 工作日必须提交；缺失记录 + 通知 PM + 计入统计。
- **补填规则**: 默认禁止补填/修改；PM 可配置放开。
- **审批**: 提交不更新进度；PM 审核通过后更新任务进度。

### 2.3 进度管理
- **任务进度**: PM 审核日报时更新；允许回退。
- **里程碑/阶段进度**: PM 手动维护；系统展示“建议进度”（按任务工时加权，仅展示）。
- **视图**: 里程碑视图与任务视图可切换。

### 2.4 周报
- **生成**: 默认按日报汇总。
- **审批**: PM 审核。

---

## 3. 权限、通知与日志

### 角色
- **员工**: 查看被分配任务、提交日报、查看自身周报。
- **PM**: 任务下发/调整/审批日报/进度维护/批量操作。
- **管理员**: 权限与配置维护。
- **部门负责人**: 只读查看本部门项目/任务/日报/周报/统计。

### 通知（站内）
- 任务下发/转派通知。
- 日报待审核提醒。
- 工作日未提交提醒。

### 日志
- 任务/里程碑关键变更记录（负责人、计划时间、状态、进度）。
- 日报审批操作记录。

---

## 4. 老系统日报回写设计

### 回写规则
- 提交日报 → 创建老系统日报。
- 审批通过 → 更新同一条老系统日报。
- **按项目拆分**: 一份日报多项目时拆为多条 `pms_report`。
- **标题**: `项目名 + 日期`。
- **内容**: 该项目下任务明细 + 工时。
- **工时**: 项目任务工时合计。
- **时间范围**: 取该项目任务计划时间最早/最晚。

### 执行方式
- 同一部署内通过 `IPmsReportService` 写入/更新 `pms_report`，不走 HTTP。

### 可靠性
- 新建同步审计表（PENDING/PROCESSING/SUCCESS/FAILED）。
- 自动重试 + 人工触发重试。
- 幂等：`eff_daily_report_id + project_id` 唯一。

---

## 5. 批量能力与附件

### 批量操作优先级
1. 批量下发任务
2. 批量调整计划时间
3. 批量调整状态

### 附件
- 日报支持附件（复用 OSS）。
- 限制：单文件 ≤ 20MB；类型：jpg/png/pdf/docx/xlsx/zip/doc/xls。

---

## 6. 关键统计指标
- 延期任务数
- 工时消耗 vs 计划
- 里程碑进度总览
- 成员工时排行

---

## 7. 开发计划（阶段交付）

**阶段 1：模型与基础能力（1 周）**
- 任务层级、模板、日报结构、角色权限、菜单。

**阶段 2：流程与进度（1–2 周）**
- 任务下发/转派/批量操作；进度更新与延期处理。

**阶段 3：日报与周报（1 周）**
- 日报规则、审批、缺失提醒；周报汇总与审核。

**阶段 4：老系统日报回写（1 周）**
- 同步审计表、异步回写、人工重试、按项目拆分。

**阶段 5：验收与对账（1 周）**
- 统计口径对齐、回写对账报告、验收文档。

---

## 8. 风险与待确认
- 任务计划时间缺失时的时间范围回退规则。
- 周报审批细则（驳回处理、修改限制）。
- PM 配置补填规则的 UI 与权限入口。

