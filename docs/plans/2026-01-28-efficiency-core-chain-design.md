# 人效中心核心链路设计方案（任务+日报+进度+周报+回写）

**日期**: 2026-01-28
**范围**: 人效中心模块（不改动老 PMS 功能）

---

## 1. 目标与范围

### 目标
- 老系统录入项目，人效中心完成任务拆分/下发、进度管理与日报闭环。
- 日报回写到老系统 `pms_report`，两块功能并行且保持连接。
- 任务、日报、进度、周报形成完整项目管理闭环。

### 范围
- 任务管理：阶段→里程碑→周/日任务。
- 日报管理：每日一份、多条任务明细、工作日必报。
- 进度管理：PM 审核后更新任务进度，可回退。
- 周报管理：日报汇总生成、PM 审核。
- 老系统回写：日报按项目拆分回写，准实时异步。

### 约束
- 仅在人效中心目录开发；老 PMS 功能不修改。
- 同一部署内调用 Service，避免 HTTP 网络开销。

---

## 2. 核心业务设计

### 2.1 任务结构
- **层级**: 阶段 → 里程碑 → 周/日任务。
- **阶段模板**: 可配置，默认 5 阶段。
- **里程碑**: 支持自动生成 + 手动创建。
- **任务拆分**: PM 自主选择拆到周或日。
- **任务模板**: 系统内置 + 历史项目复制；应用时支持按角色映射负责人。
- **状态流转**: PENDING → IN_PROGRESS → DELAYED → COMPLETED。
- **延期**: 到期未完成自动标记 + PM 手动标记；允许调整计划时间并记录原因。
- **归档**: 任务不可删除，仅归档；有工时的归档任务参与统计。

### 2.2 日报与审批
- **日报结构**: 每日一份，包含多条任务明细。
- **约束**: 员工仅对已下发任务填报进度/成果。
- **频率**: 工作日必须提交；缺失记录 + 通知 PM + 计入统计。
- **补填规则**: 默认禁止补填/修改；PM 可配置放开。
- **审批**: 提交不更新进度；PM 审核通过后更新任务进度。

### 2.3 进度管理
- **任务进度**: PM 审核日报时更新；允许回退。
- **里程碑/阶段进度**: PM 手动维护；系统展示“建议进度”（按任务工时加权，仅展示）。
- **视图**: 里程碑视图与任务视图可切换。

### 2.4 周报
- **生成方式**: 系统自动生成 + 员工可编辑补充。
- **周期**: 工作周（周一-周五）。
- **提交时间**: 周五下班前。
- **审批**: 不需要审批，提交即生效。
- **内容结构**: 本周总结 / 主要成果 / 问题 / 下周计划。
- **视图**: 个人总览周报 + 项目拆分周报（同时提供）。

### 2.5 周报生成规则与缺失处理
- **本周总结**: 汇总工作周内日报 summary + 任务完成摘要（可编辑）。
- **主要成果**: 提取完成度=100%的任务与成果要点（可编辑）。
- **问题**: 汇总日报 issues 去重合并（可编辑）。
- **下周计划**: 优先取最后一天日报 tomorrowPlan；无则生成未完成任务清单（可编辑）。
- **工时**: 工作周内日报工时合计；项目拆分按项目归集。
- **缺失日报**: 标记缺失天数，通知 PM/员工，并计入统计。
- **未提交周报**: 标记未提交并计入统计。
- **补交规则**: 默认不允许补交；PM 可配置放开并记录变更。

### 2.6 补填/修改配置（日报+周报）
- **层级**: 全局默认（关闭） + 项目级覆盖。
- **默认**: 严格当天不可补填/修改，仅 PM 可开启。
- **项目覆盖**: 允许补填与修改（不限时间），默认窗口 7 天（可配置）。
- **审批**: 不需要。
- **理由**: 不需要。
- **生效范围**: 日报 + 周报。
- **日志**: 记录配置变更（开关与窗口天数）。

### 2.7 项目初始化与排期衔接
- **入口**: 项目详情页“初始化/排期” + 项目列表“快速初始化”。
- **状态**: 新项目进入人效中心后标记为“未排期”。
- **流程**: 选择模板 → 自动排期 → PM 调整 → 保存 → 生成任务并下发。
- **规则**: 自动排期仅为建议，PM 可修改后生效。

### 2.8 任务模板结构与应用
- **层级**: 阶段 → 里程碑 → 任务。
- **任务字段**: 名称、计划工时、负责人角色、计划起止时间、任务描述、验收标准。
- **角色映射**: 角色维度（前端/后端/测试/产品/设计），仅作人员分配建议。
- **版本管理**: 模板版本可回溯，项目记录使用版本。
- **可见范围**: 系统模板 + 部门模板 + 个人模板。
- **应用流程**: 选模板 → 局部选择 → 角色映射建议 → 自动排期 → PM 调整 → 保存 → 生成任务并下发。
- **排期规则**: 按模板默认工期顺序排期，仅作建议，PM 调整后落库。

### 2.9 附件与成果链接
- **挂载对象**: 任务 + 日报明细均可添加附件/成果链接。
- **查看权限**: 项目成员 + PM + 部门负责人可见。
- **删除权限**: 上传者 + PM + 管理员可删除。
- **存储方式**: 复用 OSS/文件上传逻辑。
- **限制**: 单文件 ≤ 20MB；类型：jpg/png/pdf/docx/xlsx/zip/doc/xls。

### 2.10 统计口径（延期 / 工时 / 进度）
- **延期判定**: 自动（到期未完成）+ 手动标记均计入延期。
- **延期统计**: 排除已归档且无工时任务；支持时间维度切换（当前月/项目）。
- **工时对比**: 同时展示两套口径：
  1) 任务计划工时 vs 日报任务工时
  2) 里程碑/阶段预算 vs 日报工时
- **建议进度**: 按任务计划工时加权计算，仅用于参考展示。
- **成员排行**: 支持工作周/自然月切换。

### 2.11 批量操作规则
- **范围**: 仅限同一项目内批量操作。
- **批量下发**: 支持统一负责人或按角色映射建议，PM 确认生效。
- **批量时间**: 支持统一设置开始/结束日期，或整体顺延/提前（+N/-N天）。
- **批量状态**: 允许跳跃变更，但需记录变更理由（审计）。
- **归档任务**: 允许参与全部批量操作。

### 2.12 任务转派与历史归属
- **历史归属**: PM 可选择保留原日报/进度归属或迁移给新负责人。
- **原因**: 转派原因不必填。
- **通知**: 同时通知原负责人和新负责人。
- **状态限制**: 已完成/已归档任务可转派，但需 PM 二次确认。
- **进度处理**: 转派后进度由 PM 选择保留或重置。
- **批量转派**: 仅允许同一里程碑内任务批量转派。

---

## 3. 权限、通知与日志

### 角色
- **员工**: 查看被分配任务、提交日报、查看自身周报。
- **PM**: 任务下发/调整/审批日报/进度维护/批量操作。
- **管理员**: 权限与配置维护。
- **部门负责人**: 只读查看本部门项目/任务/日报/周报/统计。

### 通知（站内）
- 任务下发/转派通知。
- 日报待审核提醒。
- 工作日未提交提醒。

### 日志
- 任务/里程碑关键变更记录（负责人、计划时间、状态、进度）。
- 日报审批操作记录。

---

## 4. 老系统日报回写设计

### 回写规则
- 提交日报 → 创建老系统日报。
- 审批通过 → 更新同一条老系统日报。
- **按项目拆分**: 一份日报多项目时拆为多条 `pms_report`。
- **标题**: `项目名 + 日期`。
- **内容**: 该项目下任务明细 + 工时。
- **工时**: 项目任务工时合计。
- **时间范围**: 取该项目任务计划时间最早/最晚。

### 执行方式
- 同一部署内通过 `IPmsReportService` 写入/更新 `pms_report`，不走 HTTP。

### 可靠性
- 新建同步审计表（PENDING/PROCESSING/SUCCESS/FAILED）。
- 自动重试 + 人工触发重试。
- 幂等：`eff_daily_report_id + project_id` 唯一。

### 同步审计表结构（eff_sync_audit）
- `id` 主键自增
- `eff_daily_report_id` 人效日报 ID
- `project_id` 项目 ID
- `pms_report_id` 老系统日报 ID（成功后回填）
- `status` 状态：PENDING/PROCESSING/SUCCESS/FAILED
- `attempts` 重试次数
- `last_error` 最后一次错误信息
- `next_retry_time` 下次重试时间
- `create_time` 创建时间
- `update_time` 更新时间


---

## 5. 批量能力与附件

### 批量操作优先级
1. 批量下发任务
2. 批量调整计划时间
3. 批量调整状态

### 附件
- 日报支持附件（复用 OSS）。
- 限制：单文件 ≤ 20MB；类型：jpg/png/pdf/docx/xlsx/zip/doc/xls。

---

## 6. 关键统计指标
- 延期任务数
- 工时消耗 vs 计划
- 里程碑进度总览
- 成员工时排行

---

## 7. 开发计划（阶段交付）

**阶段 1：模型与基础能力（1 周）**
- 任务层级、模板、日报结构、角色权限、菜单。

**阶段 2：流程与进度（1–2 周）**
- 任务下发/转派/批量操作；进度更新与延期处理。

**阶段 3：日报与周报（1 周）**
- 日报规则、审批、缺失提醒；周报汇总与审核。

**阶段 4：老系统日报回写（1 周）**
- 同步审计表、异步回写、人工重试、按项目拆分。

**阶段 5：验收与对账（1 周）**
- 统计口径对齐、回写对账报告、验收文档。

---

## 8. 风险与待确认
- 任务计划时间缺失时的时间范围回退规则。
- 周报审批细则（驳回处理、修改限制）。
- PM 配置补填规则的 UI 与权限入口。

## 9. 验证清单
- 详见：`docs/plans/2026-01-28-efficiency-verification.md`
