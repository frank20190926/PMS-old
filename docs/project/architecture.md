# System Architecture

<!-- SCOPE: System architecture documentation following arc42 template with C4 diagrams -->
<!-- NO_CODE_EXAMPLES: This document defines architecture, not implementations -->

## 1. Introduction and Goals

### 1.1 Requirements Overview

PMS 项目管理系统是基于 RuoYi-Vue 框架开发的企业级绩效执行管理系统。

| 目标 | 描述 |
|------|------|
| 项目管理 | 支持项目全生命周期管理 |
| 人效管理 | 任务分配、日报、周报、工时统计 |
| 权限控制 | 基于角色的细粒度权限管理 |
| 数据分析 | 仪表盘、看板、甘特图可视化 |

### 1.2 Quality Goals

| 优先级 | 质量目标 | 描述 |
|--------|----------|------|
| 1 | 可用性 | 系统稳定运行，故障快速恢复 |
| 2 | 安全性 | 身份认证、权限控制、数据保护 |
| 3 | 可维护性 | 模块化设计，易于扩展和修改 |
| 4 | 性能 | 响应快速，支持并发访问 |

### 1.3 Stakeholders

| 角色 | 关注点 |
|------|--------|
| 管理员 | 系统配置、用户权限、监控 |
| 项目经理 | 任务分配、进度跟踪、日报审核 |
| 员工 | 任务执行、日报填写 |
| 运维人员 | 系统部署、监控、维护 |

---

## 2. Architecture Constraints

### 2.1 Technical Constraints

| 约束 | 说明 |
|------|------|
| TC-01 | 基于 RuoYi-Vue 3.8.6 框架 |
| TC-02 | Java 11 运行环境 |
| TC-03 | MySQL 8.0+ 数据库 |
| TC-04 | Redis 6.0+ 缓存 |
| TC-05 | 前后端分离架构 |

### 2.2 Organizational Constraints

| 约束 | 说明 |
|------|------|
| OC-01 | 人效中心代码限制在 efficiency/ 目录 |
| OC-02 | 遵循 RuoYi 框架规范 |
| OC-03 | 单机部署环境 |

---

## 3. System Scope and Context

### 3.1 Business Context

```
┌─────────────────────────────────────────────────────────────────┐
│                        External Actors                          │
├─────────────────────────────────────────────────────────────────┤
│   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐  │
│   │  Admin  │     │   PM    │     │Employee │     │  Ops    │  │
│   └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘  │
│        │               │               │               │        │
│        └───────────────┴───────────────┴───────────────┘        │
│                              │                                   │
│                              ▼                                   │
│                    ┌─────────────────┐                          │
│                    │   PMS System    │                          │
│                    └─────────────────┘                          │
│                              │                                   │
│                              ▼                                   │
│        ┌─────────────────────┴─────────────────────┐            │
│        │                                           │            │
│   ┌────▼────┐                               ┌──────▼─────┐      │
│   │  MySQL  │                               │   Redis    │      │
│   └─────────┘                               └────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Technical Context

| 接口 | 协议 | 说明 |
|------|------|------|
| 前端 → 后端 | HTTP/REST | Axios 请求，JWT 认证 |
| 后端 → MySQL | JDBC | Druid 连接池 |
| 后端 → Redis | Redis Protocol | Lettuce 客户端 |

---

## 4. Solution Strategy

| 策略 | 实现 |
|------|------|
| 分层架构 | Controller → Service → Mapper → Database |
| 模块化 | RuoYi 模块 + Application 业务模块 |
| 权限控制 | Spring Security + JWT + RBAC |
| 缓存策略 | Redis 缓存用户信息和配置 |
| API 规范 | RESTful + Swagger 文档 |

---

## 5. Building Block View

### 5.1 Level 1: System Context (C4)

```
┌─────────────────────────────────────────────────────────────────┐
│                         PMS System                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────┐        ┌───────────────────────────────┐ │
│  │   Vue Frontend    │◄──────►│      Spring Boot Backend      │ │
│  │   (Port 1024)     │  REST  │        (Port 8090)            │ │
│  └───────────────────┘        └───────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 Level 2: Container View

```
┌─────────────────────────────────────────────────────────────────┐
│                     kml-pms-v2-vue (Frontend)                    │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌───────┐ │
│  │  Views  │  │   API   │  │  Store  │  │ Router  │  │ Utils │ │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └───────┘ │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                   kml-pms-v2-server (Backend)                    │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ ruoyi-admin │  │ruoyi-system │  │ application │              │
│  │   (Entry)   │  │   (RBAC)    │  │    (PMS)    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ruoyi-framew │  │ruoyi-common │  │ruoyi-quartz │              │
│  │  (Security) │  │   (Utils)   │  │   (Jobs)    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 Level 3: Component View (Application Module)

```
┌─────────────────────────────────────────────────────────────────┐
│                    application (com.app.pms)                     │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    efficiency/ (人效中心)                    ││
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        ││
│  │  │Controller│►│ Service  │►│  Mapper  │►│  Domain  │        ││
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘        ││
│  │  ┌──────────────────────────────────────────────────┐       ││
│  │  │                    sync/ (数据同步)              │       ││
│  │  └──────────────────────────────────────────────────┘       ││
│  └─────────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              其他模块 (controller, service, domain, mapper)  ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. Runtime View

### 6.1 用户登录流程

```
┌────────┐     ┌─────────┐     ┌──────────────┐     ┌───────┐
│ Client │     │ Vue App │     │ Spring Boot  │     │ Redis │
└───┬────┘     └────┬────┘     └──────┬───────┘     └───┬───┘
    │               │                  │                 │
    │ 1. Login      │                  │                 │
    ├──────────────►│                  │                 │
    │               │ 2. POST /login   │                 │
    │               ├─────────────────►│                 │
    │               │                  │ 3. Verify       │
    │               │                  ├────────────────►│
    │               │                  │ 4. Store Token  │
    │               │                  │◄────────────────┤
    │               │ 5. JWT Token     │                 │
    │               │◄─────────────────┤                 │
    │ 6. Store Token│                  │                 │
    │◄──────────────┤                  │                 │
```

### 6.2 日报提交流程

```
┌────────┐     ┌─────────┐     ┌──────────────┐     ┌───────┐
│Employee│     │ Vue App │     │ Spring Boot  │     │ MySQL │
└───┬────┘     └────┬────┘     └──────┬───────┘     └───┬───┘
    │               │                  │                 │
    │ 1. Fill Report│                  │                 │
    ├──────────────►│                  │                 │
    │               │ 2. POST /daily   │                 │
    │               ├─────────────────►│                 │
    │               │                  │ 3. Validate     │
    │               │                  │ 4. Save Report  │
    │               │                  ├────────────────►│
    │               │                  │ 5. OK           │
    │               │                  │◄────────────────┤
    │               │ 6. Success       │                 │
    │               │◄─────────────────┤                 │
    │ 7. Show Result│                  │                 │
    │◄──────────────┤                  │                 │
```

---

## 7. Deployment View

```
┌─────────────────────────────────────────────────────────────────┐
│                       Production Server                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────┐        ┌───────────────────────────────┐ │
│  │   Nginx (80/443)  │        │     Java 11 Runtime           │ │
│  │   Static Files    │◄──────►│   Spring Boot App (8090)      │ │
│  │   Reverse Proxy   │        │                               │ │
│  └───────────────────┘        └───────────────────────────────┘ │
│                                         │                        │
│                          ┌──────────────┴──────────────┐        │
│                          ▼                              ▼        │
│               ┌─────────────────┐           ┌─────────────────┐ │
│               │   MySQL (3306)  │           │  Redis (6379)   │ │
│               │   kml-pms DB    │           │   Cache         │ │
│               └─────────────────┘           └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. Cross-cutting Concepts

### 8.1 Security

| 概念 | 实现 |
|------|------|
| 认证 | JWT Token (有效期 14400 分钟) |
| 授权 | Spring Security + RBAC |
| 加密 | RSA 密码加密 |
| XSS | 全局 XSS 过滤 |

### 8.2 Logging

| 概念 | 实现 |
|------|------|
| 框架 | SLF4J + Logback |
| 级别 | com.ruoyi: DEBUG, org.springframework: WARN |
| 存储 | logs/ 目录 |

### 8.3 Exception Handling

| 异常类型 | 处理方式 |
|----------|----------|
| 业务异常 | 返回错误码和消息 |
| 系统异常 | 记录日志，返回通用错误 |
| 认证异常 | 返回 401 |
| 授权异常 | 返回 403 |

---

## 9. Architecture Decisions

| ADR | 决策 | 状态 |
|-----|------|------|
| ADR-001 | 采用 RuoYi-Vue 框架 | Accepted |
| ADR-002 | 使用 MyBatis-Plus 替代原生 MyBatis | Accepted |
| ADR-003 | 人效中心独立模块 (efficiency/) | Accepted |
| ADR-004 | 数据同步采用增量同步策略 | Accepted |

---

## 10. Quality Requirements

### 10.1 Quality Scenarios

| 场景 | 刺激 | 响应 | 度量 |
|------|------|------|------|
| 性能 | 100 用户并发 | 页面正常响应 | 响应时间 < 3s |
| 可用性 | 服务重启 | 自动恢复 | 恢复时间 < 5min |
| 安全性 | 暴力破解 | 账户锁定 | 5 次错误锁定 10min |

---

## 11. Risks and Technical Debt

### 11.1 Risks

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 单点故障 | 服务不可用 | 定期备份，快速恢复 |
| 数据库性能 | 响应变慢 | 索引优化，慢 SQL 监控 |

### 11.2 Technical Debt

| 债务 | 描述 | 优先级 |
|------|------|--------|
| TD-001 | coderbox/license-auth 模块已移除 | Low |
| TD-002 | 节假日 API 功能已禁用 | Low |

---

## Maintenance

### Update Triggers

| 触发条件 | 操作 |
|----------|------|
| 新模块添加 | 更新 Building Block View |
| 架构变更 | 更新相关章节 |
| 新技术决策 | 添加 ADR |

### Verification Checklist

- [ ] 所有 C4 图层完整
- [ ] 运行视图覆盖核心流程
- [ ] 部署视图反映实际环境
- [ ] ADR 列表最新

### Last Updated

2026-01-23
